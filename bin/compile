#!/bin/bash

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

# Load dependencies
source $BP_DIR/lib/output.sh
source $BP_DIR/lib/json.sh
source $BP_DIR/lib/failure.sh
source $BP_DIR/lib/environment.sh
source $BP_DIR/lib/binaries.sh
source $BP_DIR/lib/cache.sh
source $BP_DIR/lib/dependencies.sh

export METEOR_ALLOW_SUPERUSER=true

# Load environment
export_env_dir $ENV_DIR

echo "-----> Installing Node.js"
install_nodejs "$BUILD_DIR" "$CACHE_DIR"

echo "-----> Installing Meteor"
install_meteor "$BUILD_DIR" "$CACHE_DIR"

echo "-----> Building Meteor app"
cd $BUILD_DIR
meteor build --directory .build --server-only

echo "-----> Installing dependencies"
cd .build/bundle/programs/server
npm install

echo "-----> Cleaning up"
cd $BUILD_DIR
rm -rf .meteor/local

# Create a Procfile if it doesn't exist
if [ ! -f $BUILD_DIR/Procfile ]; then
  echo "-----> Creating Procfile"
  echo "web: METEOR_ALLOW_SUPERUSER=true node .build/bundle/main.js" > $BUILD_DIR/Procfile
fi